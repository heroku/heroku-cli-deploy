version: 2

jobs:
  build:
    machine:
      enabled: true
      image: circleci/node:7.8.0
    steps:
      - checkout
      - restore_cache:
          keys:
            - node_modules-{{ checksum "package.json" }}
            - node_modules-
      - run:
          name: Pre-test
          command: |
            bash etc/ci-setup.sh
            yarn install
      - save_cache:
          paths:
            - node_modules
          key: node_modules-{{ checksum "package.json" }}
      - run:
          name: Test
          command: yarn test
      - run:
          name: Post-test
          command: if [ -n "$HEROKU_API_KEY" ]; then heroku keys:remove $(whoami)@$(hostname | sed -e "s/\.localdomain//g"); fi
